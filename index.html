<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学术个人主页</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <header class="top-header">
        <h1 class="site-title">姚泽全的个人主页</h1>
    </header>

    <nav class="sidebar">
        <div class="nav-items">
            <a href="#basic-info">
                <i class="fas fa-user"></i>
                <span>基本信息</span>
            </a>
            <a href="#experience">
                <i class="fas fa-history"></i>
                <span>个人经历</span>
            </a>
            <a href="#research">
                <i class="fas fa-flask"></i>
                <span>科学研究</span>
            </a>
            <a href="#awards">
                <i class="fas fa-trophy"></i>
                <span>获奖经历</span>
            </a>
            <a href="#publications">
                <i class="fas fa-book"></i>
                <span>学术成果</span>
            </a>
            <a href="#positions">
                <i class="fas fa-briefcase"></i>
                <span>社会兼职</span>
            </a>
            <a href="#activities">
                <i class="fas fa-calendar-alt"></i>
                <span>学术活动</span>
            </a>
            <a href="#gallery">
                <i class="fas fa-images"></i>
                <span>图片集</span>
            </a>
            <button type="button" id="edit-toggle" class="edit-button nav-button">
                <i class="fas fa-edit"></i>
                <span>编辑模式</span>
            </button>
        </div>
    </nav>

    <main class="content">
        <div class="format-toolbar" style="display: none;">
            <button class="format-btn" data-format="bold" title="加粗">
                <i class="fas fa-bold"></i>
            </button>
            <button class="format-btn" data-format="italic" title="斜体">
                <i class="fas fa-italic"></i>
            </button>
            <select class="font-size-picker" title="字体大小">
                <option value="1">小</option>
                <option value="3" selected>正常</option>
                <option value="5">大</option>
                <option value="7">特大</option>
            </select>
            <input type="color" class="color-picker" title="文字颜色" value="#2c3e50">
        </div>

        <section id="basic-info" class="section">
            <h1>基本信息</h1>
            <div class="profile-container">
                <div class="profile-image">
                    <img src="./my photo.jpg" alt="个人照片">
                </div>
                <div class="profile-info">
                    <h2>您的姓名</h2>
                    <p>职称：教授</p>
                    <p>所在单位：XX大学XX学院</p>
                    <p>研究方向：XXXX</p>
                    <p>邮箱：example@university.edu</p>
                </div>
            </div>
        </section>

        <section id="experience" class="section">
            <h2>个人经历</h2>
            <div class="timeline">
                <h3>教育经历</h3>
                <div class="timeline-items education">
                    <div class="timeline-item">
                        <button class="delete-btn" style="display: none">×</button>
                        <div class="time">20XX - 20XX</div>
                        <div class="content">
                            <h4>XX大学</h4>
                            <p>博士学位 - 专业名称</p>
                        </div>
                    </div>
                </div>
                <button class="add-item-btn" data-type="education" style="display: none;">
                    添加教育经历
                </button>

                <h3>工作经历</h3>
                <div class="timeline-items work">
                    <div class="timeline-item">
                        <button class="delete-btn" style="display: none">×</button>
                        <div class="time">20XX - 至今</div>
                        <div class="content">
                            <h4>XX大学</h4>
                            <p>教授</p>
                        </div>
                    </div>
                </div>
                <button class="add-item-btn" data-type="work" style="display: none;">
                    添加工作经历
                </button>
            </div>
        </section>

        <section id="research" class="section">
            <h2>科学研究</h2>
            <div class="research-projects">
                <div class="project">
                    <button class="delete-btn" style="display: none">×</button>
                    <h3>研究项目一</h3>
                    <p>项目描述...</p>
                </div>
            </div>
            <button class="add-item-btn" data-type="research" style="display: none;">
                添加研究项目
            </button>
        </section>

        <section id="awards" class="section">
            <h2>获奖经历</h2>
            <div class="awards-container">
                <h3>学业奖励</h3>
                <ul class="publication-list academic-awards">
                    <li>
                        <button class="delete-btn" style="display: none">×</button>
                        <span class="award-content" data-image="" contenteditable="true">1. 20XX年 奖项名称</span>
                        <input type="file" class="award-image" accept="image/*" style="display: none;">
                        <button class="upload-btn" style="display: none">上传图片</button>
                    </li>
                </ul>
                <button class="add-item-btn" data-type="academic-award" style="display: none;">
                    添加学业奖励
                </button>

                <h3>竞赛奖励</h3>
                <ul class="publication-list competition-awards">
                    <li>
                        <button class="delete-btn" style="display: none">×</button>
                        1. 20XX年 奖项名称
                    </li>
                </ul>
                <button class="add-item-btn" data-type="competition-award" style="display: none;">
                    添加竞赛奖励
                </button>

                <h3>社会奖励</h3>
                <ul class="publication-list social-awards">
                    <li>
                        <button class="delete-btn" style="display: none">×</button>
                        1. 20XX年 奖项名称
                    </li>
                </ul>
                <button class="add-item-btn" data-type="social-award" style="display: none;">
                    添加社会奖励
                </button>
            </div>
        </section>

        <section id="publications" class="section">
            <h2>学术成果</h2>
            <div class="publications-container">
                <h3>期刊论文</h3>
                <ul class="publication-list journal-papers">
                    <li>1.</li>
                    <li>2.</li>
                </ul>
                <button class="add-item-btn" data-type="journal" style="display: none;">
                    添加期刊论文
                </button>

                <h3>会议论文</h3>
                <ul class="publication-list conference-papers">
                    <li>1.</li>
                    <li>2.</li>
                </ul>
                <button class="add-item-btn" data-type="conference" style="display: none;">
                    添加会议论文
                </button>

                <h3>专利和软著</h3>
                <ul class="publication-list patents">
                    <li>1.</li>
                    <li>2.</li>
                </ul>
                <button class="add-item-btn" data-type="patent" style="display: none;">
                    添加专利/软著
                </button>

                <h3>专著</h3>
                <ul class="publication-list books">
                    <li>1.</li>
                    <li>2.</li>
                </ul>
                <button class="add-item-btn" data-type="book" style="display: none;">
                    添加专著
                </button>
            </div>
        </section>

        <section id="positions" class="section">
            <h2>社会兼职</h2>
            <ul class="positions-list">
                <li>
                    <button class="delete-btn" style="display: none">×</button>
                    <span class="position-time">20XX - 至今</span>
                    <span class="position-title">职务名称</span>
                    <span class="position-org">组织名称</span>
                </li>
            </ul>
            <button class="add-item-btn" data-type="position" style="display: none;">
                添加社会兼职
            </button>
        </section>

        <section id="activities" class="section">
            <h2>学术活动</h2>
            <div class="activities-container">
                <div class="activity">
                    <button class="delete-btn" style="display: none">×</button>
                    <h3>会议名称</h3>
                    <p>时间：20XX年XX月</p>
                    <p>地点：城市，国家</p>
                    <p>角色：主讲人/与会者等</p>
                </div>
            </div>
            <button class="add-item-btn" data-type="activity" style="display: none;">
                添加学术活动
            </button>
        </section>

        <section id="gallery" class="section">
            <h2>图片集</h2>
            <div class="gallery-container">
                <!-- 图片将在这里动态显示 -->
            </div>
        </section>

    </main>

    <script>
    // 检查 jQuery 是否正确加载
    if (typeof jQuery === 'undefined') {
        console.error('jQuery is not loaded!');
    } else {
        console.log('jQuery version:', jQuery.fn.jquery);
    }

    let isEditMode = false;
    let isAdmin = false;  // 添加管理员状态标记
    const ADMIN_CONTENT_KEY = 'adminPageContent';  // 作者编辑版本
    const PUBLIC_CONTENT_KEY = 'publicPageContent';  // 访客可见版本

    // 添加 GitHub API 相关代码
    const REPO_OWNER = 'zequanyao';
    const REPO_NAME = 'zequanyao.github.io';

    // 在 script 标签内添加以下代码（替换原有的 localStorage 相关代码）

    const GITHUB_TOKEN = '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'; // 这里粘贴您的 token
    
    // 保存内容到 GitHub
    async function saveToGitHub(content) {
        try {
            // 首先获取现有文件的 SHA
            let sha = '';
            try {
                const getResponse = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/content.json`);
                const fileData = await getResponse.json();
                sha = fileData.sha;
            } catch (error) {
                console.log('File does not exist yet');
            }
    
            // 保存内容
            const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/content.json`, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${GITHUB_TOKEN}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: 'Update content',
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(content)))),
                    sha: sha || undefined
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to save content');
            }
            
            console.log('Content saved successfully');
        } catch (error) {
            console.error('Failed to save content:', error);
            alert('保存失败，请重试');
        }
    }
    
    // 从 GitHub 加载内容
    async function loadFromGitHub() {
        try {
            const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/content.json`);
            if (!response.ok) {
                throw new Error('Content not found');
            }
            const data = await response.json();
            return JSON.parse(decodeURIComponent(escape(atob(data.content))));
        } catch (error) {
            console.error('Failed to load content:', error);
            return null;
        }
    }
    
    // 修改发布按钮的处理
    $('.publish-btn').click(async function() {
        if (isAdmin && confirm('确定要发布最新内容吗？这将更新访客可见的版本。')) {
            const content = $('main').html();
            const $tempContent = $('<div>').html(content);
            $tempContent.find('.delete-btn, .add-item-btn, .upload-btn').remove();
            await saveToGitHub({
                adminContent: content,
                publicContent: $tempContent.html()
            });
            alert('内容已发布！');
        }
    });
    
    // 修改自动保存功能
    async function autoSave() {
        if (isEditMode) {
            const content = $('main').html();
            const $tempContent = $('<div>').html(content);
            $tempContent.find('.delete-btn, .add-item-btn, .upload-btn').remove();
            await saveToGitHub({
                adminContent: content,
                publicContent: $tempContent.html()
            });
            console.log('Content auto-saved');
        }
    }
    
    // 在页面加载时获取内容
    $(document).ready(async function() {
        // ... 其他初始化代码 ...
    
        // 尝试从 GitHub 加载内容
        const githubContent = await loadFromGitHub();
        if (githubContent) {
            if (isAdmin) {
                $('main').html(githubContent.adminContent);
                addDeleteButtons();
            } else {
                $('main').html(githubContent.publicContent);
            }
        }
    });

    // 保存内容到 localStorage
    function saveContent(content) {
        localStorage.setItem(ADMIN_CONTENT_KEY, content.adminContent);
        localStorage.setItem(PUBLIC_CONTENT_KEY, content.publicContent);
    }

    // 从 GitHub 加载内容
    async function loadFromGitHub() {
        try {
            const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/content.json`);
            const data = await response.json();
            window.contentSHA = data.sha;
            return JSON.parse(atob(data.content));
        } catch (error) {
            console.error('Failed to load content:', error);
            return null;
        }
    }

    // 修改登录函数
    function checkLogin() {
        const password = prompt('请输入管理员密码：');
        if (password === '123') {  // 替换为您的密码
            isAdmin = true;
            localStorage.setItem('isAdmin', 'true');  // 保存管理员状态
            return true;
        }
        alert('密码错误，无法进入编辑模式');
        return false;
    }

    $(document).ready(async function() {
        // 默认隐藏格式工具栏
        $('.format-toolbar').hide();

        // 添加发布按钮
        $('<button>')
            .addClass('publish-btn')
            .html('<i class="fas fa-globe"></i> 发布')
            .insertAfter('#edit-toggle')
            .hide()
            .click(function() {
                if (isAdmin && confirm('确定要发布最新内容吗？这将更新访客可见的版本。')) {
                    const content = $('main').html();
                    const $tempContent = $('<div>').html(content);
                    $tempContent.find('.delete-btn, .add-item-btn, .upload-btn').remove();
                    saveContent({
                        adminContent: content,
                        publicContent: $tempContent.html()
                    });
                    alert('内容已发布！');
                }
            });

        // 添加退出按钮
        $('<button>')
            .addClass('logout-btn')
            .html('<i class="fas fa-sign-out-alt"></i> 退出')
            .insertAfter('#edit-toggle')
            .hide()
            .click(function() {
                if (confirm('确定要退出登录吗？')) {
                    isAdmin = false;
                    localStorage.removeItem('isAdmin');
                    location.reload();  // 刷新页面
                }
            });

        // 添加导出/导入按钮
        $('<button>')
            .addClass('export-btn')
            .html('<i class="fas fa-download"></i> 导出')
            .insertAfter('.logout-btn')
            .hide()
            .click(function() {
                const data = {
                    adminContent: localStorage.getItem(ADMIN_CONTENT_KEY),
                    publicContent: localStorage.getItem(PUBLIC_CONTENT_KEY)
                };
                const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'website_content.json';
                a.click();
            });

        $('<button>')
            .addClass('import-btn')
            .html('<i class="fas fa-upload"></i> 导入')
            .insertAfter('.export-btn')
            .hide()
            .click(function() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = function(e) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            localStorage.setItem(ADMIN_CONTENT_KEY, data.adminContent);
                            localStorage.setItem(PUBLIC_CONTENT_KEY, data.publicContent);
                            location.reload();
                        } catch (error) {
                            alert('导入失败，请确保文件格式正确');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            });

        // 默认隐藏所有管理按钮
        $('#edit-toggle, .publish-btn, .logout-btn').hide();
        
        // 检查是否是管理员
        const savedAdminStatus = localStorage.getItem('isAdmin');
        if (savedAdminStatus === 'true') {
            isAdmin = true;
            const adminContent = localStorage.getItem(ADMIN_CONTENT_KEY);
            if (adminContent) {
                $('main').html(adminContent);
                addDeleteButtons();
            }
            $('#edit-toggle').show();
            $('.publish-btn').show();
            $('.logout-btn').show();
            $('.export-btn').show();
            $('.import-btn').show();
        } else {
            // 访客模式：加载公开版本
            const publicContent = localStorage.getItem(PUBLIC_CONTENT_KEY);
            if (publicContent) {
                $('main').html(publicContent);
            }
        }

        // 添加快捷键组合触发登录
        $(document).on('keydown', function(e) {
            if (e.ctrlKey && e.altKey && e.key === 'e') {
                if (!isAdmin && checkLogin()) {
                    // 登录成功后加载管理员版本
                    const adminContent = localStorage.getItem(ADMIN_CONTENT_KEY);
                    if (adminContent) {
                        $('main').html(adminContent);
                        addDeleteButtons();
                    }
                    $('#edit-toggle').show();
                    $('.publish-btn').show();
                    $('.logout-btn').show();
                }
            }
        });

        $('#edit-toggle').on('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // 确保只有管理员可以编辑
            if (!isAdmin) {
                alert('请先登录管理员账号');
                return;
            }
            
            isEditMode = !isEditMode;
            $(this).toggleClass('active');
            
            if (isEditMode) {
                $('.section').addClass('editable');
                $('h2, h3, h4, p, .time, .content p, .award-content, .position-time, .position-title, .position-org, .publication-list li').attr('contenteditable', 'true');
                $('.delete-btn, .add-item-btn').css('display', 'block');
                $('.upload-btn').css('display', 'block');
                alert('已启用编辑模式，您可以直接点击文字进行编辑');
                $('.format-toolbar').show();  // 只在编辑模式下显示工具栏
            } else {
                $('.section').removeClass('editable');
                $('[contenteditable]').attr('contenteditable', 'false');
                $('.delete-btn, .add-item-btn').css('display', 'none');
                $('.upload-btn').css('display', 'none');
                $('.format-toolbar').hide();  // 退出编辑模式时隐藏工具栏
                const content = $('main').html();
                localStorage.setItem(ADMIN_CONTENT_KEY, content);
                // 创建一个干净的公开版本（移除所有编辑按钮和上传按钮）
                const $tempContent = $('<div>').html(content);
                $tempContent.find('.delete-btn, .add-item-btn, .upload-btn').remove();
                localStorage.setItem(PUBLIC_CONTENT_KEY, $tempContent.html());
                // 同时保存到 GitHub
                saveToGitHub({
                    adminContent: content,
                    publicContent: $tempContent.html()
                });
                alert('已退出编辑模式');
            }
        });

        // 修改自动保存功能
        function autoSave() {
            if (isEditMode) {
                localStorage.setItem(ADMIN_CONTENT_KEY, $('main').html());
                // 同时保存到 GitHub
                const content = $('main').html();
                const $tempContent = $('<div>').html(content);
                $tempContent.find('.delete-btn, .add-item-btn, .upload-btn').remove();
                saveToGitHub({
                    adminContent: content,
                    publicContent: $tempContent.html()
                });
                console.log('Content auto-saved');
            }
        }

        // 监听内容变化自动保存
        $(document).on('input', '[contenteditable="true"]', function() {
            autoSave();
        });
        // 添加更多保存触发点
        $(document).on('blur', '[contenteditable="true"]', autoSave);
        $(document).on('change', '.award-image', autoSave);
        $(document).on('click', '.delete-btn', autoSave);
        $(document).on('click', '.add-item-btn', function() {
            if (!isEditMode || !isAdmin) {
                alert('请先进入编辑模式');
                return;
            }
            
            const $section = $(this).closest('.section');
            const itemType = $(this).data('type');
            
            let newContent = '';
            let index;
            switch(itemType) {
                case 'education':
                    newContent = `
                        <div class="timeline-item">
                            <button class="delete-btn" style="display: ${isEditMode ? 'block' : 'none'}">×</button>
                            <div class="time" contenteditable="true">20XX - 20XX</div>
                            <div class="content">
                                <h4 contenteditable="true">学校名称</h4>
                                <p contenteditable="true">学位 - 专业</p>
                            </div>
                        </div>
                    `;
                    break;

                case 'work':
                    newContent = `
                        <div class="timeline-item">
                            <button class="delete-btn" style="display: ${isEditMode ? 'block' : 'none'}">×</button>
                            <div class="time" contenteditable="true">20XX - 20XX</div>
                            <div class="content">
                                <h4 contenteditable="true">单位名称</h4>
                                <p contenteditable="true">职位</p>
                            </div>
                        </div>
                    `;
                    break;

                case 'research':
                    newContent = `
                        <div class="project">
                            <button class="delete-btn" style="display: ${isEditMode ? 'block' : 'none'}">×</button>
                            <h3 contenteditable="true">新研究项目</h3>
                            <p contenteditable="true">项目描述...</p>
                        </div>
                    `;
                    break;

                case 'academic-award':
                    index = $('.academic-awards').children('li').length + 1;
                    newContent = `
                        <li>
                            <button class="delete-btn" style="display: ${isEditMode ? 'block' : 'none'}">×</button>
                            <span class="award-content" data-image="" contenteditable="true">${index}. 20XX年 奖项名称</span>
                            <input type="file" class="award-image" accept="image/*" style="display: none;">
                            <button class="upload-btn" style="display: ${isEditMode ? 'block' : 'none'}">上传图片</button>
                        </li>
                    `;
                    break;

                case 'competition-award':
                case 'social-award':
                    index = $(`.${itemType}s`).children('li').length + 1;
                    newContent = `
                        <li>
                            <button class="delete-btn" style="display: ${isEditMode ? 'block' : 'none'}">×</button>
                            <span class="award-content" data-image="" contenteditable="true">${index}. 20XX年 奖项名称</span>
                            <input type="file" class="award-image" accept="image/*" style="display: none;">
                            <button class="upload-btn" style="display: ${isEditMode ? 'block' : 'none'}">上传图片</button>
                        </li>
                    `;
                    break;

                case 'position':
                    newContent = `
                        <li>
                            <button class="delete-btn" style="display: ${isEditMode ? 'block' : 'none'}">×</button>
                            <span class="position-time" contenteditable="true">20XX - 至今</span>
                            <span class="position-title" contenteditable="true">职务名称</span>
                            <span class="position-org" contenteditable="true">组织名称</span>
                        </li>
                    `;
                    break;

                case 'activity':
                    newContent = `
                        <div class="activity">
                            <button class="delete-btn" style="display: ${isEditMode ? 'block' : 'none'}">×</button>
                            <h3 contenteditable="true">会议名称</h3>
                            <p contenteditable="true">时间：20XX年XX月</p>
                            <p contenteditable="true">地点：城市，国家</p>
                            <p contenteditable="true">角色：主讲人/与会者等</p>
                        </div>
                    `;
                    break;

                case 'journal':
                case 'conference':
                case 'patent':
                case 'book':
                    index = $(`.${itemType}s`).children('li').length + 1;
                    newContent = `
                        <li>
                            <button class="delete-btn" style="display: ${isEditMode ? 'block' : 'none'}">×</button>
                            <span contenteditable="true">${index}. 新的${itemType === 'journal' ? '期刊论文' : 
                                                                      itemType === 'conference' ? '会议论文' : 
                                                                      itemType === 'patent' ? '专利/软著' : '专著'}...</span>
                        </li>
                    `;
                    break;
            }

            // 添加新内容到对应的容器
            switch(itemType) {
                case 'education':
                    $('.timeline-items.education').append(newContent);
                    break;
                case 'work':
                    $('.timeline-items.work').append(newContent);
                    break;
                case 'research':
                    $('.research-projects').append(newContent);
                    break;
                case 'position':
                    $('.positions-list').append(newContent);
                    break;
                case 'activity':
                    $('.activities-container').append(newContent);
                    break;
                case 'journal':
                    $('.journal-papers').append(newContent);
                    break;
                case 'conference':
                    $('.conference-papers').append(newContent);
                    break;
                case 'patent':
                    $('.patents').append(newContent);
                    break;
                case 'book':
                    $('.books').append(newContent);
                    break;
                case 'academic-award':
                    $('.academic-awards').append(newContent);
                    break;
                case 'competition-award':
                    $('.competition-awards').append(newContent);
                    break;
                case 'social-award':
                    $('.social-awards').append(newContent);
                    break;
            }

            // 重新计算序号
            if (['academic-award', 'competition-award', 'social-award'].includes(itemType)) {
                $(`.${itemType}s li`).each(function(index) {
                    const $content = $(this).find('.award-content');
                    const text = $content.text();
                    $content.text(`${index + 1}.${text.substring(text.indexOf('.') + 1)}`);
                });
            }

            // 添加后立即显示删除按钮（如果在编辑模式）
            if (isEditMode) {
                $('.delete-btn').show();  // 确保所有删除按钮都显示
            }

            // 确保新添加的内容可编辑
            if (isEditMode) {
                $('[contenteditable]').attr('contenteditable', 'true');  // 确保所有可编辑元素都可编辑
            }
            
            // 自动保存
            autoSave();
        });

        // 添加删除功能
        $(document).on('click', '.delete-btn', function(e) {
            e.preventDefault();
            if (confirm('确定要删除这个项目吗？')) {
                $(this).closest('.timeline-item, .project, li, .activity').remove();
            }
        });

        // 为现有的项目添加删除按钮
        function addDeleteButtons() {
            $('.timeline-item, .project, .awards-list li, .publication-list li, .positions-list li, .activity, .research-projects .project').each(function() {
                if (!$(this).find('.delete-btn').length) {
                    $(this).prepend(`<button class="delete-btn" style="display: none">×</button>`);
                }
            });
        }

        // 处理格式化按钮点击
        $('.format-btn').click(function() {
            const format = $(this).data('format');
            document.execCommand(format, false, null);
            $(this).toggleClass('active');
        });

        // 处理颜色选择
        $('.color-picker').change(function() {
            document.execCommand('foreColor', false, $(this).val());
        });

        // 处理字体大小选择
        $('.font-size-picker').change(function() {
            document.execCommand('fontSize', false, $(this).val());
        });

        // 处理图片上传
        $(document).on('click', '.upload-btn', function() {
            $(this).siblings('.award-image').click();
        });

        $(document).on('change', '.award-image', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                const $btn = $(this);
                const $awardContent = $btn.siblings('.award-content');
                const awardText = $awardContent.text().trim();
                
                reader.onload = function(e) {
                    // 保存图片数据到奖项内容
                    $awardContent.attr('data-image', e.target.result);
                    
                    // 添加到图片集
                    const newImage = `
                        <div class="gallery-item">
                            <img src="${e.target.result}" alt="获奖照片">
                            <div class="caption">${awardText}</div>
                        </div>
                    `;
                    $('.gallery-container').append(newImage);
                };
                
                reader.readAsDataURL(file);
            }
        });

        // 监听选中文本的变化以更新工具栏状态
        $(document).on('selectionchange', function() {
            $('.format-btn').each(function() {
                const format = $(this).data('format');
                if (document.queryCommandState(format)) {
                    $(this).addClass('active');
                } else {
                    $(this).removeClass('active');
                }
            });
        });

        // 点击奖项显示图片
        $(document).on('click', '.award-content', function() {
            const imageData = $(this).attr('data-image');
            if (imageData && !isEditMode) {
                $('.image-preview-modal img').attr('src', imageData);
                $('.image-preview-modal').css('display', 'flex');
            }
        });

        // 关闭图片预览
        $('.close-modal').click(function() {
            $('.image-preview-modal').hide();
        });

        // 图片旋转
        let rotation = 0;
        $('.rotate-left').click(function() {
            rotation -= 90;
            $('.modal-content img').css('transform', `rotate(${rotation}deg)`);
        });

        $('.rotate-right').click(function() {
            rotation += 90;
            $('.modal-content img').css('transform', `rotate(${rotation}deg)`);
        });

        // 点击模态框背景关闭
        $('.image-preview-modal').click(function(e) {
            if (e.target === this) {
                $(this).hide();
                rotation = 0;
                $('.modal-content img').css('transform', 'rotate(0deg)');
            }
        });

        // 尝试从 GitHub 加载内容
        const githubContent = await loadFromGitHub();
        if (githubContent) {
            if (isAdmin) {
                $('main').html(githubContent.adminContent);
            } else {
                $('main').html(githubContent.publicContent);
            }
        }
    });
    </script>

    <!-- 添加图片预览模态框 -->
    <div class="image-preview-modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <img src="" alt="奖项图片">
            <div class="rotate-controls">
                <button class="rotate-left"><i class="fas fa-undo"></i></button>
                <button class="rotate-right"><i class="fas fa-redo"></i></button>
            </div>
        </div>
    </div>
</body>
</html>
